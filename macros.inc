PARAMETERSSET MACRO HASH:REQ,BASE:REQ 
 ; set:
 ; rcx = BASE
 ; rdx = HASH
 mfence
 imul rax,0
 inc rax
 mov rcx,HASH
 imul rcx
 stc ; 4 cmovc;)
 cmovc rdx,rax
 mov rcx,BASE
ENDM

PUSHREGS MACRO
; pushad is not valid on x64 
 push rbx
 push rcx
 push rdi
 push rsi
 push rdx
 push r8
 push r9
 push r10
 push r11
 push r12
 push r13
 push r14
 push r15
ENDM

POPREGS MACRO
; popad
 pop r15
 pop r14
 pop r13
 pop r12
 pop r11
 pop r10
 pop r9
 pop r8
 pop rdx
 pop rsi
 pop rdi
 pop rcx
 pop rbx
ENDM

PUSHRETCALL MACRO API:REQ
  sub rsp,4*8
  call $+5
  add qword ptr [rsp],9
  push API
  db 0C3h ; RET
  add rsp,4*8
ENDM

CALLEX MACRO API:REQ
 add rsp,-4*8
 call qword ptr API
 add rsp,4*8
ENDM

GETOPTIONALHEADER MACRO
 ; rcx = base adress of module
 mov eax,dword ptr [rcx+3Ch]
 add rcx,rax
 add rcx,24 ; OptionalHeader
ENDM

GETTLSDIRECTORY MACRO
 ; rcx = base adress of module
 GETOPTIONALHEADER
 add rcx,184 ; Thread Local Storage Size+RVA pointer
ENDM

ALIGNVALUE MACRO VALUE:REQ,ALIGN:REQ
    push rcx
	push rdi
	mov rcx,ALIGN
	mov rdi,VALUE
	dec rcx
	add rdi,rcx
	not rcx
	and rdi,rcx
	mov VALUE,rdi
	pop rdi
	pop rcx	
ENDM